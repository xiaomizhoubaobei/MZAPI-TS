name: 同步代码到gitee和CNB
on:
  pull_request:
    branches:
      - main
    types: [closed]
    paths:
      - 'src/**'

permissions:
  contents: read

jobs:
  sync-code:
    permissions:
      contents: write # for Git to git push
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && github.event.sender.type != 'Bot'
    env:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      GITEE_USER: ${{ secrets.GITEE_USER }}
      GITEE_EMAIL: ${{ secrets.GITEE_EMAIL }}
      CNB_USER: ${{ secrets.CNB_USER }}
      CNB_EMAIL: ${{ secrets.CNB_EMAIL }}
      CNB_TOKEN: ${{ secrets.CNB_TOKEN }}
      ATOMGITNAME: ${{ secrets.ATOMGITNAME }}
      ATOMGITTOKEN: ${{ secrets.ATOMGITTOKEN }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Configure Git User for Gitee
        run: |
          git config --global user.name "${{ secrets.GITEE_USER }}"
          git config --global user.email "${{ secrets.GITEE_EMAIL }}"

      - name: Add Gitee Remote
        run: git remote add gitee git@gitee.com:qinjielove/mzapi-ts.git

      - name: Push to Gitee
        run: git push gitee main

      - name: Configure Git User for CNB
        run: |
          git config --global user.name "${{ secrets.CNB_USER }}"
          git config --global user.email "${{ secrets.CNB_EMAIL }}"

      - name: Add CNB Remote
        run: git remote add cnb https://${{ secrets.CNB_TOKEN }}@cnb.cool/XMZZUZHI/MZAPI/TypeScript

      - name: Push to CNB
        run: git push cnb main

      - name: Configure Git User for Atomgit
        run: |
          git config --global user.name "${{ secrets.ATOMGITNAME }}"
          git config --global user.email "${{ secrets.CNB_EMAIL }}"

      - name: Add Atomgit Remote
        run: git remote add atomgit https://${{ secrets.ATOMGITNAME }}:${{ secrets.ATOMGITTOKEN }}@atomgit.com/qixiaoxin1/mzapi-ts.git

      - name: Push to Atomgit
        run: git push atomgit main