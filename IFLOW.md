# IFLOW.md - 核心工作规则

## 1. 元约束（Meta Constraints）

> 违反任意一条即视为任务失败，无任何修复机会

- 100 % 中文回复（zh-CN，简体，技术术语可保留英文）
- 100 % 先调用子代理（无例外，主上下文只做路由）
- 100 % 通过基础安全检查（无恶意代码、无敏感数据泄露）
- 100 % 遵循编程规范与工程原则（SOLID、KISS、DRY、YAGNI）

## 2. 子代理路由表（强制自动触发）

| 触发条件                           | 子代理                 | 额外指令                |
|--------------------------------|---------------------|---------------------|
| `.py/.cs/.js/.ts/.cpp/.go/.rs` | `tech-stack-expert` | 先输出「代码规范检查清单」再编码    |
| `.unity/.prefab`               | `unity-developer`   | 强制场景/预制体双评审         |
| `package.json/.csproj/.sln`    | `tech-stack-expert` | 先执行依赖漏洞扫描           |
| 关键词「代码/编程/bug/错误」              | `tech-stack-expert` | 必须给出「最小可复现案例」       |
| 关键词「搜索/查找/分析」                  | `search-specialist` | 必须返回「多源交叉验证结果」      |
| 关键词「架构/设计/API」                 | `backend-architect` | 强制输出「六边形架构图」与「接口契约」 |
| 关键词「测试/部署/优化」                  | `devops-optimizer`  | 必须附带「性能基线对比」        |
| 未命中以上                          | `general-purpose`   | 先执行「任务复杂度评分」再决策     |

## 3. 子代理工作模板（复杂度下沉）

1. **任务拆解**：输出「用户故事 → 技术任务」映射表
2. **工具链**：在子代理内部按顺序调用 MCP 工具（search → urls_fetch → code/write）
3. **代码评审**：必须执行「静态扫描 + 单元测试 + 性能剖析」三重门禁
4. **结果验证**：对照「CR 检查单」与「工程原则检查单」双签字后方可返回主上下文

## 4. 编程规范（强制内嵌）

| 维度     | 规约                                          |
|--------|---------------------------------------------|
| 命名     | 统一使用英文驼峰/蛇式，禁止拼音；常量全大写加下划线                  |
| 函数     | 单行长度 ≤ 80；圈复杂度 ≤ 5；必须纯函数优先                  |
| 类      | 单文件单类；职责 > 1 立即拆分（SRP）                      |
| 注释     | 公共 API 必须包行内文档（docstring）；业务代码「为什么」 > 「做什么」 |
| 异常     | 禁止裸 `except:`；自定义异常继承自 `DomainException`    |
| 测试     | 新增代码覆盖率 ≥ 90 %；TDD 红线 → 绿线 → 重构流程           |
| 包管理器   | 锁定依赖版本；定期更新（每月一次）                           |
| 使用yarn | 使用 `yarn` 替代 `npm` 进行包管理，确保一致性和性能优化         |
| git    | 提交信息遵循 Conventional Commits 规范              |
| git推送  | 每次更新源码之后不要擅作主张未经用户同意直接使用git push进行推送        |

## 5. 工程原则检查单（YAGNI 守门员）

- [ ] SOLID：每接口仅一个变更理由；依赖倒置已用端口 - 适配器
- [ ] KISS：无重复抽象，无「未来可能用」的代码
- [ ] DRY：相同逻辑 > 1 行即抽公共函数 / 配置
- [ ] YAGNI：没有当前需求对应的代码 / 字段 / 配置一律删除

## 6. 安全检查单（零容忍）

- [ ] 无硬编码密钥、密码、内网 IP
- [ ] 无动态拼接 SQL / Shell / URL
- [ ] 无反序列化不可信数据
- [ ] 第三方库版本已扫漏洞（`osv.dev` 与 `snyk` 双源）

## 7. 输出格式契约

- 代码块必须带语言标记 + 文件名
- 架构图使用 Mermaid；时序图必须含「调用链超时」标注
- 所有建议按「优先级（P0/P1/P2）+ 影响面 + 落地成本」三列表格呈现

## 8. 主上下文只做 3 件事

1. 识别
2. 路由
3. 验收

其余一切复杂度下沉到子代理，确保主上下文 < 200 token 即可闭环。
